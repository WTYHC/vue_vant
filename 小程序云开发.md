#  小程序云开发

##  基础

AppID不使用测试号

## 数据库

### 连接数据库：`const db = wx.cloud.database()`

![image-20210721210511810](C:\Users\WT\AppData\Roaming\Typora\typora-user-images\image-20210721210511810.png)

### 连接哪一个数据库：`db.collection(集合名称)`

### 获取数据

#### 获取集合中所有的数据

```js
db.collection(集合名称).get({
  success: function(res) {
    console.log(res.data)//返回的是所有属于这个集合的记录
  }
})

等同于
db.collection(集合名称).get().then(res=>{
     console.log(res.data)
}).catch(err=>{ //错误返回的结果
      console.log(err)
})
```

#### 获取一个记录的数据

```js
db.collection('demolist').doc('28ee4e3e60f818ef2c66507e45935ee6').get({
      success: function(res) {
        // res 只返回集合名称为demolist id为28ee4e3e60f818ef2c66507e45935ee6的数据
        console.log(res)
      }
 })
```

###  添加数据

#### 基础添加

```  js
addData:function () {
    db.collection("demolist").add({
      data:{
        title:"测试",
        content:"添加数据"
      }
    }).then(res=>{
      console.log(res);
    })
 },
```

```  js
addData:function () {
    // 避免一直点击添加数据，点击添加数据后，
    // 进行一个数据加载，数据添加成功后关闭
    wx.showLoading({
      title: '数据添加中',
      mask:true
    })
    db.collection("demolist").add({
      data:{
        title:"测试",
        content:"添加数据"
      }
    }).then(res=>{
      console.log(res);
      wx.hideLoading();
    })
  },
```

####  表单添加数据到云数据库

在`wxml`中:

```html
<form bindsubmit="submitData">
   <input type="text" name="title" placeholder="请输入标题"/>
   <textarea name="content"></textarea>
   <button type="primary" form-type="submit">提交</button>
</form>
```

``` js
submitData:function (e) {
     console.log(e);
    //  获取值(方法一)
    // var title = e.detail.value.title;
    // var content = e.detail.value.content;

    // 获取值使用es6的写法（方法2）
    // var {title,content} = e.detail.value;
    // db.collection("demolist").add({
    //   data:{
    //     title:title,
    //     content:content
    //   }
    // }).then(res=>{
    //   console.log(res);
    // })

    // 因为返回的value值是一个对象直接赋值（法3）
    var value = e.detail.value;
    db.collection("demolist").add({
      data:value
    }).then(res=>{
      console.log(res);
    })
  },
```

###     更新数据

 ####  update 局部更新一个或多个记录

``` js
updateData:function () { 
db.collection("demolist").doc("b00064a760f96dbf296e4ccb3cbd8637").update({
         data:{
           content:"修改后的数据",
           date:"2021.7.23" //也可以新增字段
         }
     }).then(res=>{
       console.log(res);
     })
  },
```

![image-20210723093947414](C:\Users\WT\AppData\Roaming\Typora\typora-user-images\image-20210723093947414.png)

####  set   替换更新一个记录 即更新一个字段值为另一个对象

```js
   db.collection("demolist").doc("b00064a760f96dbf296e4ccb3cbd8637").set({
      data:{
        content:"set方法修改后的数据",
        date:"2021.7.23" //也可以新增字段
       }
    }).then(res=>{
      console.log(res);
    })
```



![image-20210723094221136](C:\Users\WT\AppData\Roaming\Typora\typora-user-images\image-20210723094221136.png)

注：如果需要更新多个数据，需在 Server 端进行操作（**云函数**），在 `where` 语句后同样的调用 `update` 方法即可

###  删除数据  

 ####  删除一条记录 remove()

``` js
 db.collection("demolist").doc("b00064a760f95709296918d01b2ea8cb")
 .remove({}).then(res => {
      console.log(res);
  })
```

注：控制台添加的数据不能用此方法删除，只能删除在小程序中添加的数据

**获取输入框输入_id的值进行删除**

在`wxml`中

```  html
<input style="margin-top:20rpx" type="text" placeholder="请输入要删除的数据的_id" bindinput="inputValue" />
<button style="margin-top:20rpx" type="primary" bindtap="delData">删除一条记录</button>
```

![image-20210723114824483](C:\Users\WT\AppData\Roaming\Typora\typora-user-images\image-20210723114824483.png)

``` js
  // 获取输入框中的值
  inputValue:function (e) {
     console.log(e.detail.value);
     inValue = e.detail.value
  },
  delData: function () {
    db.collection("demolist").doc(inValue).remove({}).then(res => {
      console.log(res);
    })
  },
```

#### 删除多条记录      如果需要更新多个数据，需在 Server 端进行操作（云函数）。

###  count个数与watch数据监听

``` JS
 db.collection("demolist").count().then(res=>{
   console.log(res);
 })
```

```   js
 db.collection("demolist").watch({  //监听数据
      onChange: function(res) {
        console.log('snapshot', res)
      },
      onError: function(err) {
        console.error('the watch closed because of error', err)
      }
 })
```

![image-20210723144930117](C:\Users\WT\AppData\Roaming\Typora\typora-user-images\image-20210723144930117.png)

###    条件查询

####  where

```js
 // 在 demolist 中查询 字段 content的值为添加数据
 db.collection("demolist").where({
      content:"添加数据"
 }).get().then(res=>{
     console.log(res);
 })
```

####  limit

指定查询结果集数量上限

```  js
// 查询前三条数据
db.collection("demolist").limit(3).get().then(res=>{
console.log(res);
})
```

#### orderBy

```
 // 查询前三条，并根据时间倒序排序
 // 升序 asc   倒序 desc
 db.collection("demolist").limit(3).orderBy("time","desc").get().then(res=>{
 console.log(res);
 })
```

![image-20210723171133605](C:\Users\WT\AppData\Roaming\Typora\typora-user-images\image-20210723171133605.png)

#### skip 

指定查询返回结果时从指定序列后的结果开始返回，常用于分页

```  js
// 返回第5条之后的结果
  db.collection('demolist').skip(5)
  .get()
  .then(res=>{
    console.log(res);
  })
```

####  field

指定返回结果中记录需返回的字段

```  js
  // 返回title、time两个字段
  db.collection('demolist').field({
     title:true,
     time:true,
  }).get()
    .then(res =>{
      console.log(res);
  })
```



![image-20210723172506544](C:\Users\WT\AppData\Roaming\Typora\typora-user-images\image-20210723172506544.png)

####  Command

数据库操作符，通过 `db.command` 获取

![image-20210723201908087](C:\Users\WT\AppData\Roaming\Typora\typora-user-images\image-20210723201908087.png)

```js
 // 获得满足其中一个条件的数据
  getData:function () {
     db.collection("demolist").where(
        _.or([{
          content:"添加数据"
        },
        {
          date:"2021.7.23"
        }
      ])
     ).get().then(res=>{
       console.log(res);
       this.setData({
         dataList:res.data
       })
     })
  },
```

##  云函数

### 基础

1. 在cloudfuncation 文件夹单击右键 新建node.js云函数文件夹

2. 将 "node.js云函数文件夹"  上传并部署

3. 在 index.js 文件中  在init() 下面初始化数据库 (**记住修改文件后要更新文件 重新上传部署一下**)

   ```js
   const db = cloud.database()
   ```

   ```js
   // 云函数入口函数
   exports.main = async (event, context) => {
     // 返回从数据库中请求数据 await等待异步完成
     return await db.collection("demolist").get();
   }
   ```

4. 在界面的 js文件中引用（请求云函数）

   ``` js
    wx.cloud.callFunction({
            name:"getData", //云函数文件名
       }).then(res=>{
            console.log(res);
   })
   ```




### 云函数中传递参数

在界面js 文件中

``` js
 wx.cloud.callFunction({
         name:"getData", //云函数文件名
         data:{
           num:3,//将参数传递到云函数中
         }
       }).then(res=>{
         console.log(res);
    })
```

在云函数文件夹下的index.js中

```js
exports.main = async (event, context) => {
  // 用event接收传过来的数据
   var num =  event.num;
  // 返回从数据库中请求数据 返回的是数据库中前3条数据
  return await db.collection("demolist").limit(num).get();
}
```







 





